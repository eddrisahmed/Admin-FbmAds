<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FbmAds Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { 
            background-color: #1f2937; 
            color: #d1d5db;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar a { border-left: 3px solid transparent; transition: all 0.2s; }
        .sidebar a:hover { background-color: #374151; }
        .sidebar a.active { background-color: #4f46e5; color: white; border-left-color: #818cf8; }
        .stat-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
        }
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background-color: #10b981;
            border-radius: 50%;
            border: 2px solid #1f2937;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        .filter-active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Admin Login -->
    <div id="admin-login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-center text-gray-900">Admin Panel Login</h1>
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 border rounded-lg">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg">
            <button id="admin-login-btn" class="w-full btn btn-primary">Login</button>
        </div>
    </div>

    <!-- Main Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="sidebar w-64 flex-shrink-0 absolute lg:relative z-50 lg:z-auto">
                <div class="p-4 text-2xl font-bold text-white flex justify-between items-center">
                    <span>Fbm Ads Admin</span>
                    <button id="close-sidebar" class="lg:hidden text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav class="mt-8">
                    <a href="#" class="nav-link block py-3 px-4 active relative" data-page="dashboard-page">
                        <i data-lucide="home" class="inline-block w-5 h-5 mr-2"></i>Dashboard
                    </a>
                    <a href="#" class="nav-link block py-3 px-4 relative" data-page="users-page">
                        <i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Users
                        <span id="users-notification" class="notification-dot hidden"></span>
                    </a>
                    <a href="#" class="nav-link block py-3 px-4 relative" data-page="withdrawals-page">
                        <i data-lucide="dollar-sign" class="inline-block w-5 h-5 mr-2"></i>Withdrawals
                        <span id="withdrawals-notification" class="notification-dot hidden"></span>
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="tasks-page">
                        <i data-lucide="tasks" class="inline-block w-5 h-5 mr-2"></i>Tasks
                        <span id="tasks-notification" class="notification-dot hidden"></span>
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="referral-page">
                        <i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Referral
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="levels-page">
                        <i data-lucide="trending-up" class="inline-block w-5 h-5 mr-2"></i>Levels
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="notifications-page">
                        <i data-lucide="send" class="inline-block w-5 h-5 mr-2"></i>Notifications
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="settings-page">
                        <i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i>Settings
                    </a>
                    <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8"><i data-lucide="log-out" class="inline-block w-5 h-5 mr-2"></i>Logout</a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 lg:p-8 overflow-y-auto">
                <!-- Header with toggle button -->
                <div class="flex items-center mb-6">
                    <button id="sidebar-toggle" class="lg:hidden mr-4">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h1 class="text-2xl lg:text-3xl font-bold" id="page-title">Dashboard Overview</h1>
                    <div id="header-notification" class="ml-4 hidden"></div>
                </div>

                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                        <div class="stat-card p-4 lg:p-6"><h2 class="text-gray-500 text-sm lg:text-lg">Total Users</h2><p id="total-users" class="text-2xl lg:text-4xl font-bold mt-2">0</p></div>
                        <div class="stat-card p-4 lg:p-6"><h2 class="text-gray-500 text-sm lg:text-lg">Active Today</h2><p id="active-users" class="text-2xl lg:text-4xl font-bold mt-2">0</p></div>
                        <div class="stat-card p-4 lg:p-6"><h2 class="text-gray-500 text-sm lg:text-lg">Pending Withdrawals</h2><p id="pending-withdrawals" class="text-2xl lg:text-4xl font-bold mt-2">0</p></div>
                        <div class="stat-card p-4 lg:p-6"><h2 class="text-gray-500 text-sm lg:text-lg">Total Earnings</h2><p id="total-earnings" class="text-2xl lg:text-4xl font-bold mt-2">0</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Recent Withdrawals</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead><tr><th>User</th><th>Amount</th><th>Status</th></tr></thead>
                                    <tbody id="recent-withdrawals"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">System Health</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span>Firebase Connection</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Active</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Database Status</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Online</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Ad Service</span>
                                    <span id="ad-service-status" class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Checking...</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>New Withdrawals</span>
                                    <span id="new-withdrawals-count" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="users-page" class="page">
                    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                        <h1 class="text-2xl lg:text-3xl font-bold">User Management</h1>
                        <div class="flex flex-col lg:flex-row gap-2 w-full lg:w-auto">
                            <input type="text" id="user-search" placeholder="Search by email..." class="w-full px-4 py-2 border rounded-lg">
                            <div class="flex gap-2">
                                <select id="user-filter" class="px-4 py-2 border rounded-lg">
                                    <option value="all">All Users</option>
                                    <option value="level">Filter by Level</option>
                                    <option value="balance">Filter by Balance</option>
                                    <option value="referrals">Filter by Referrals</option>
                                    <option value="active">Active Users</option>
                                    <option value="blocked">Blocked Users</option>
                                </select>
                                <select id="user-sort" class="px-4 py-2 border rounded-lg">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="level-high">Level: High to Low</option>
                                    <option value="level-low">Level: Low to High</option>
                                    <option value="balance-high">Balance: High to Low</option>
                                    <option value="balance-low">Balance: Low to High</option>
                                </select>
                                <button class="btn btn-primary whitespace-nowrap" onclick="exportUsers()">Export</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Level</th>
                                    <th>Referrals</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="users-count">Showing 0 users</div>
                        <div class="flex gap-2" id="users-pagination"></div>
                    </div>
                </div>

                <!-- Withdrawals Page -->
                <div id="withdrawals-page" class="page">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-6">Withdrawal Requests</h1>
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button class="btn btn-primary filter-active" onclick="filterWithdrawals('all')">All</button>
                        <button class="btn btn-warning" onclick="filterWithdrawals('pending')">Pending</button>
                        <button class="btn btn-success" onclick="filterWithdrawals('approved')">Approved</button>
                        <button class="btn btn-danger" onclick="filterWithdrawals('rejected')">Rejected</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>User Name</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Details</th>
                                    <th>Requested At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table-body">
                                <!-- Withdrawals data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="withdrawals-count">Showing 0 withdrawals</div>
                        <div class="flex gap-2" id="withdrawals-pagination"></div>
                    </div>
                </div>

                <!-- Tasks Management Page -->
                <div id="tasks-page" class="page">
                    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6">
                        <h1 class="text-2xl lg:text-3xl font-bold">Task Management</h1>
                        <button class="btn btn-primary mt-2 lg:mt-0" onclick="showCreateTaskModal()">Create New Task</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6 lg:mb-8">
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Task Configuration</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Daily Task Limit</label>
                                    <input type="number" id="daily-task-limit" class="w-full px-4 py-2 border rounded-lg" value="10">
                                </div>
                                <button class="btn btn-primary" onclick="updateTaskConfig()">Update Configuration</button>
                            </div>
                        </div>

                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Task Statistics</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>Total Tasks</span>
                                    <span id="total-tasks-count">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Active Tasks</span>
                                    <span id="active-tasks-count">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Completed Today</span>
                                    <span id="completed-tasks-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card p-4 lg:p-6">
                        <h2 class="text-xl font-bold mb-4">All Tasks</h2>
                        <div class="overflow-x-auto">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Task Name</th>
                                        <th>Type</th>
                                        <th>Reward</th>
                                        <th>Completed</th>
                                        <th>Limit</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body">
                                    <!-- Tasks will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Referral Settings Page -->
                <div id="referral-page" class="page">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-6">Referral System Settings</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6 lg:mb-8">
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Referral Bonuses</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Referrer Bonus (Coins)</label>
                                    <input type="number" id="referrer-bonus" class="w-full px-4 py-2 border rounded-lg" placeholder="100">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Referee Bonus (Coins)</label>
                                    <input type="number" id="referee-bonus" class="w-full px-4 py-2 border rounded-lg" placeholder="100">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="referral-enabled" class="rounded" checked>
                                    <label class="font-semibold">Referral System Enabled</label>
                                </div>
                                <button class="btn btn-primary" onclick="updateReferralConfig()">Save Settings</button>
                            </div>
                        </div>

                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Referral Statistics</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>Total Referrals</span>
                                    <span id="total-referrals-count">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Bonus Given</span>
                                    <span id="total-bonus-given">0 coins</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Active Referrers</span>
                                    <span id="active-referrers">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Levels Management Page -->
                <div id="levels-page" class="page">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-6">Level System Management</h1>
                    
                    <div class="stat-card p-4 lg:p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Level Configuration</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>Level</th>
                                        <th>Required Coins</th>
                                        <th>Bonus Coins</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="levels-table-body">
                                    <!-- Levels will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="stat-card p-4 lg:p-6">
                        <h2 class="text-xl font-bold mb-4">Add New Level</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block font-semibold mb-2">Level Number</label>
                                <input type="number" id="new-level-number" class="w-full px-4 py-2 border rounded-lg" min="1">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Required Coins</label>
                                <input type="number" id="new-level-required" class="w-full px-4 py-2 border rounded-lg" min="0">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Bonus Coins</label>
                                <input type="number" id="new-level-bonus" class="w-full px-4 py-2 border rounded-lg" min="0">
                            </div>
                        </div>
                        <button class="btn btn-primary mt-4" onclick="addNewLevel()">Add Level</button>
                    </div>
                </div>

                <!-- Notifications Page -->
                <div id="notifications-page" class="page">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-6">Notification Center</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Send Notification</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Title</label>
                                    <input type="text" id="notification-title" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Message</label>
                                    <textarea id="notification-message" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Target Users</label>
                                    <select id="notification-target" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="all">All Users</option>
                                        <option value="active">Active Users Only</option>
                                        <option value="inactive">Inactive Users</option>
                                    </select>
                                </div>
                                <button id="send-notification-btn" class="btn btn-primary">Send Notification</button>
                            </div>
                        </div>

                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Notification Settings</h2>
                            <div class="space-y-4">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="notification-sound-enabled" class="rounded" checked>
                                    <label class="font-semibold">Enable Notification Sound</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="notification-bell-animation" class="rounded" checked>
                                    <label class="font-semibold">Enable Bell Animation</label>
                                </div>
                                <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Settings</button>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card p-4 lg:p-6 mt-6">
                        <h2 class="text-xl font-bold mb-4">Notification History</h2>
                        <div class="overflow-y-auto max-h-96">
                            <div id="notification-history">
                                <!-- Notification history will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-6">Application Settings</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Financial Settings</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Minimum Withdrawal (Coins)</label>
                                    <input type="number" id="min-withdrawal" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Daily Ad Watch Limit</label>
                                    <input type="number" id="daily-ad-limit" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Coin Value</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="coin-value-coins" class="w-full px-4 py-2 border rounded-lg">
                                        <span>Coins = ৳</span>
                                        <input type="number" id="coin-value-inr" class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card p-4 lg:p-6">
                            <h2 class="text-xl font-bold mb-4">Bonus Settings</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Daily Login Bonus (Coins)</label>
                                    <input type="number" id="daily-login-bonus" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">7-Day Streak Bonus (Coins)</label>
                                    <input type="number" id="streak-bonus" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Payment Methods (comma-separated)</label>
                                    <input type="text" id="payment-methods" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., Bkash,Nagad,Rocket">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 stat-card p-4 lg:p-6">
                        <h2 class="text-xl font-bold mb-4">System Settings</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="maintenance-mode" class="rounded">
                                    <span>Maintenance Mode</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="registration-enabled" class="rounded" checked>
                                    <span>New Registrations</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="save-settings-btn" class="btn btn-primary">Save All Settings</button>
                        <button id="reset-settings-btn" class="btn btn-danger ml-4">Reset to Default</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="alert-message" class="mb-4 text-gray-800"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="confirm-message" class="mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h2 class="text-xl font-bold mb-4">Edit User</h2>
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-2">Balance (Coins)</label>
                    <input type="number" id="edit-user-balance" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Level</label>
                    <input type="number" id="edit-user-level" class="w-full px-4 py-2 border rounded-lg" min="1" max="5">
                </div>
                <div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="edit-user-blocked" class="rounded">
                        <span>Block User</span>
                    </label>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="edit-user-cancel" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="edit-user-save" class="btn btn-primary px-6">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="create-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl max-h-screen overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Create New Task</h2>
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-2">Task Title</label>
                    <input type="text" id="task-title" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter task title">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Description</label>
                    <textarea id="task-description" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter task description"></textarea>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Task Type</label>
                    <select id="task-type" class="w-full px-4 py-2 border rounded-lg">
                        <option value="watch_ads">Watch Ads</option>
                        <option value="group_join">Join Group</option>
                        <option value="watch_video">Watch Video</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Reward (Coins)</label>
                    <input type="number" id="task-reward" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter reward amount" min="1">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Emoji/Icon</label>
                    <input type="text" id="task-emoji" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., 📺, 👥, 🎬" maxlength="2">
                </div>
                <div id="group-link-field" class="hidden">
                    <label class="block font-semibold mb-2">Group Link</label>
                    <input type="url" id="task-group-link" class="w-full px-4 py-2 border rounded-lg" placeholder="https://example.com/group">
                </div>
                <div id="video-url-field" class="hidden">
                    <label class="block font-semibold mb-2">Video URL</label>
                    <input type="url" id="task-video-url" class="w-full px-4 py-2 border rounded-lg" placeholder="https://youtube.com/embed/video_id">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Timer Seconds (for group join)</label>
                    <input type="number" id="task-timer-seconds" class="w-full px-4 py-2 border rounded-lg" placeholder="5" min="0">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Video Seconds (for video tasks)</label>
                    <input type="number" id="task-video-seconds" class="w-full px-4 py-2 border rounded-lg" placeholder="30" min="0">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Global Limit</label>
                    <input type="number" id="task-global-limit" class="w-full px-4 py-2 border rounded-lg" placeholder="1000" min="1">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Order Position</label>
                    <input type="number" id="task-order" class="w-full px-4 py-2 border rounded-lg" placeholder="1" min="1">
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="task-enabled" class="rounded" checked>
                    <label class="font-semibold">Task Enabled</label>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeCreateTaskModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="createNewTask()" class="btn btn-primary px-6">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl max-h-screen overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Edit Task</h2>
            <div class="space-y-4">
                <input type="hidden" id="edit-task-id">
                <div>
                    <label class="block font-semibold mb-2">Task Title</label>
                    <input type="text" id="edit-task-title" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Description</label>
                    <textarea id="edit-task-description" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Task Type</label>
                    <select id="edit-task-type" class="w-full px-4 py-2 border rounded-lg" disabled>
                        <option value="watch_ads">Watch Ads</option>
                        <option value="group_join">Join Group</option>
                        <option value="watch_video">Watch Video</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Reward (Coins)</label>
                    <input type="number" id="edit-task-reward" class="w-full px-4 py-2 border rounded-lg" min="1">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Emoji/Icon</label>
                    <input type="text" id="edit-task-emoji" class="w-full px-4 py-2 border rounded-lg" maxlength="2">
                </div>
                <div id="edit-group-link-field" class="hidden">
                    <label class="block font-semibold mb-2">Group Link</label>
                    <input type="url" id="edit-task-group-link" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div id="edit-video-url-field" class="hidden">
                    <label class="block font-semibold mb-2">Video URL</label>
                    <input type="url" id="edit-task-video-url" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Timer Seconds</label>
                    <input type="number" id="edit-task-timer-seconds" class="w-full px-4 py-2 border rounded-lg" min="0">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Video Seconds</label>
                    <input type="number" id="edit-task-video-seconds" class="w-full px-4 py-2 border rounded-lg" min="0">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Global Limit</label>
                    <input type="number" id="edit-task-global-limit" class="w-full px-4 py-2 border rounded-lg" min="1">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Current Count</label>
                    <input type="number" id="edit-task-current-count" class="w-full px-4 py-2 border rounded-lg" min="0" readonly>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Order Position</label>
                    <input type="number" id="edit-task-order" class="w-full px-4 py-2 border rounded-lg" min="1">
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="edit-task-enabled" class="rounded">
                    <label class="font-semibold">Task Enabled</label>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeEditTaskModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="updateTask()" class="btn btn-primary px-6">Update Task</button>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDBkvArKeIY11CDntlf9uyWPwZIPED1WZQ",
            authDomain: "ef-earning-bot.firebaseapp.com",
            projectId: "ef-earning-bot",
            storageBucket: "ef-earning-bot.firebasestorage.app",
            messagingSenderId: "742449423671",
            appId: "1:742449423671:web:7dfbef9db2e7b4ff6726b2"
        };
        
        const ADMIN_UIDS = ["cBprAQKnN1ZjFVk3L0fXy6AQae12"]; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp, getDocs, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentAdmin = null;
        let currentEditingUserId = null;
        let currentEditingTaskId = null;
        let allUsers = [];
        let allWithdrawals = [];
        let allTasks = [];
        let unsubscribeCallbacks = [];

        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard');

        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            checkAdServiceStatus();
            onAuthStateChanged(auth, (user) => {
                if (user && ADMIN_UIDS.includes(user.uid)) {
                    currentAdmin = user;
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'block';
                    navigateTo('dashboard-page');
                    loadDashboardData();
                    loadUsers();
                    loadWithdrawals();
                    loadTasks();
                    loadSettings();
                    loadTaskConfig();
                    loadReferralConfig();
                    loadLevelConfig();
                    loadNotificationHistory();
                } else {
                    loginView.style.display = 'flex';
                    dashboardView.style.display = 'none';
                    currentAdmin = null;
                    
                    // Clean up listeners
                    unsubscribeCallbacks.forEach(unsubscribe => unsubscribe());
                    unsubscribeCallbacks = [];
                }
            });
        };

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) link.classList.add('active');
            });
            
            // Update page title
            const pageTitles = {
                'dashboard-page': 'Dashboard Overview',
                'users-page': 'User Management',
                'withdrawals-page': 'Withdrawal Requests',
                'tasks-page': 'Task Management',
                'referral-page': 'Referral Settings',
                'levels-page': 'Level Management',
                'notifications-page': 'Notification Center',
                'settings-page': 'Application Settings'
            };
            document.getElementById('page-title').textContent = pageTitles[pageId] || 'Admin Panel';
            
            // Hide notifications when navigating to the page
            if (pageId === 'withdrawals-page') {
                hideNotification('withdrawals');
            }
            if (pageId === 'users-page') {
                hideNotification('users');
            }
        }

        function setupEventListeners() {
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('reset-settings-btn').addEventListener('click', resetSettings);
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
            document.getElementById('edit-user-save').addEventListener('click', saveUserEdit);
            document.getElementById('edit-user-cancel').addEventListener('click', closeEditModal);
            
            // Sidebar toggle functionality
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.add('open');
            });
            
            document.getElementById('close-sidebar').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.remove('open');
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page) {
                    link.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        navigateTo(link.dataset.page); 
                        // Close sidebar on mobile after navigation
                        document.querySelector('.sidebar').classList.remove('open');
                    });
                }
            });

            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });

            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                document.getElementById('custom-confirm').classList.add('hidden');
            });

            // User search functionality
            document.getElementById('user-search').addEventListener('input', debounce(filterUsers, 300));
            document.getElementById('user-filter').addEventListener('change', filterUsers);
            document.getElementById('user-sort').addEventListener('change', filterUsers);

            // Task type change handlers
            document.getElementById('task-type').addEventListener('change', handleTaskTypeChange);
            document.getElementById('edit-task-type').addEventListener('change', handleEditTaskTypeChange);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function handleTaskTypeChange() {
            const type = document.getElementById('task-type').value;
            document.getElementById('group-link-field').classList.toggle('hidden', type !== 'group_join');
            document.getElementById('video-url-field').classList.toggle('hidden', type !== 'watch_video');
        }

        function handleEditTaskTypeChange() {
            const type = document.getElementById('edit-task-type').value;
            document.getElementById('edit-group-link-field').classList.toggle('hidden', type !== 'group_join');
            document.getElementById('edit-video-url-field').classList.toggle('hidden', type !== 'watch_video');
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            if (!email || !password) {
                return showAlert("Please enter both email and password.");
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) { 
                showAlert(error.message); 
            }
        }

        function loadDashboardData() {
            // Total users count
            const usersUnsubscribe = onSnapshot(collection(db, "users"), snap => {
                document.getElementById('total-users').textContent = snap.size;
            });
            unsubscribeCallbacks.push(usersUnsubscribe);

            // Active users today
            const today = new Date().toISOString().split('T')[0];
            const activeUsersUnsubscribe = onSnapshot(query(collection(db, "users"), where("lastLoginDate", "==", today)), snap => {
                document.getElementById('active-users').textContent = snap.size;
            });
            unsubscribeCallbacks.push(activeUsersUnsubscribe);

            // Pending withdrawals with notification
            const pendingWithdrawalsUnsubscribe = onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), snap => {
                document.getElementById('pending-withdrawals').textContent = snap.size;
                document.getElementById('new-withdrawals-count').textContent = snap.size;
                
                // Show notification if there are new pending withdrawals
                if (snap.size > 0) {
                    showNotification('withdrawals', snap.size);
                }
            });
            unsubscribeCallbacks.push(pendingWithdrawalsUnsubscribe);

            // Total earnings (sum of all completed withdrawals)
            const earningsUnsubscribe = onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "approved")), snap => {
                let total = 0;
                snap.forEach(doc => {
                    total += doc.data().amount || 0;
                });
                document.getElementById('total-earnings').textContent = total;
            });
            unsubscribeCallbacks.push(earningsUnsubscribe);

            // Recent withdrawals
            const recentWithdrawalsUnsubscribe = onSnapshot(query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"), limit(5)), snap => {
                const tbody = document.getElementById('recent-withdrawals');
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td>${data.userName || 'N/A'}</td>
                            <td>${data.amount} coins</td>
                            <td><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(data.status)}">${data.status}</span></td>
                        </tr>
                    `;
                });
            });
            unsubscribeCallbacks.push(recentWithdrawalsUnsubscribe);
        }

        function showNotification(type, count) {
            const notificationElement = document.getElementById(`${type}-notification`);
            const headerNotification = document.getElementById('header-notification');
            
            if (notificationElement) {
                notificationElement.classList.remove('hidden');
            }
            
            if (count > 0) {
                headerNotification.classList.remove('hidden');
                headerNotification.innerHTML = `<span class="px-2 py-1 bg-green-100 text-green-800 text-sm rounded-full">${count} new</span>`;
                
                // Update page title with notification count
                if (count > 0 && !document.title.includes('(')) {
                    document.title = `(${count}) ${document.title}`;
                }
            }
        }

        function hideNotification(type) {
            const notificationElement = document.getElementById(`${type}-notification`);
            const headerNotification = document.getElementById('header-notification');
            
            if (notificationElement) {
                notificationElement.classList.add('hidden');
            }
            
            headerNotification.classList.add('hidden');
            document.title = document.title.replace(/\(\d+\)\s*/, '');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'approved': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'rejected': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            const usersQuery = query(collection(db, "users"), orderBy("createdAt", "desc"));
            
            const usersUnsubscribe = onSnapshot(usersQuery, (snapshot) => {
                allUsers = [];
                usersTableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-gray-500">No users found</td>
                        </tr>
                    `;
                    document.getElementById('users-count').textContent = 'Showing 0 users';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    allUsers.push(user);
                });
                
                filterUsers();
            }, (error) => {
                console.error("Error loading users:", error);
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-red-500">Error loading users: ${error.message}</td>
                    </tr>
                `;
            });
            
            unsubscribeCallbacks.push(usersUnsubscribe);
        }

        function filterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const filterType = document.getElementById('user-filter').value;
            const sortType = document.getElementById('user-sort').value;
            
            let filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            // Apply additional filters
            if (filterType === 'active') {
                filteredUsers = filteredUsers.filter(user => !user.isBlocked);
            } else if (filterType === 'blocked') {
                filteredUsers = filteredUsers.filter(user => user.isBlocked);
            }
            
            // Apply sorting
            switch(sortType) {
                case 'newest':
                    filteredUsers.sort((a, b) => b.createdAt - a.createdAt);
                    break;
                case 'oldest':
                    filteredUsers.sort((a, b) => a.createdAt - b.createdAt);
                    break;
                case 'level-high':
                    filteredUsers.sort((a, b) => (b.level || 1) - (a.level || 1));
                    break;
                case 'level-low':
                    filteredUsers.sort((a, b) => (a.level || 1) - (b.level || 1));
                    break;
                case 'balance-high':
                    filteredUsers.sort((a, b) => (b.balance || 0) - (a.balance || 0));
                    break;
                case 'balance-low':
                    filteredUsers.sort((a, b) => (a.balance || 0) - (b.balance || 0));
                    break;
            }
            
            // Display filtered users
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-gray-500">No users match your search criteria</td>
                    </tr>
                `;
            } else {
                filteredUsers.forEach(user => {
                    const joinedDate = user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A';
                    const referralsCount = user.referredBy ? 1 : 0; // Simple count for demo
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="font-mono text-xs">${user.id.substring(0, 8)}...</td>
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${user.balance || 0}</td>
                            <td>${user.level || 1}</td>
                            <td>${referralsCount}</td>
                            <td><span class="px-2 py-1 text-xs rounded-full ${user.isBlocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></td>
                            <td>${joinedDate}</td>
                            <td class="space-x-2">
                                <button class="btn btn-primary text-xs" onclick="editUser('${user.id}')">Edit</button>
                                <button class="btn ${user.isBlocked ? 'btn-success' : 'btn-danger'} text-xs" onclick="toggleBlockUser('${user.id}', ${user.isBlocked || false})">${user.isBlocked ? 'Unblock' : 'Block'}</button>
                            </td>
                        </tr>
                    `;
                    usersTableBody.innerHTML += row;
                });
            }
            
            document.getElementById('users-count').textContent = `Showing ${filteredUsers.length} users`;
        }

        window.editUser = function(userId) {
            currentEditingUserId = userId;
            const userRef = doc(db, "users", userId);
            getDoc(userRef).then(docSnap => {
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    document.getElementById('edit-user-balance').value = user.balance || 0;
                    document.getElementById('edit-user-level').value = user.level || 1;
                    document.getElementById('edit-user-blocked').checked = user.isBlocked || false;
                    document.getElementById('user-edit-modal').classList.remove('hidden');
                }
            }).catch(error => {
                showAlert("Error loading user: " + error.message);
            });
        };

        window.closeEditModal = function() {
            document.getElementById('user-edit-modal').classList.add('hidden');
            currentEditingUserId = null;
        };

        async function saveUserEdit() {
            if (!currentEditingUserId) return;

            const balance = parseInt(document.getElementById('edit-user-balance').value);
            const level = parseInt(document.getElementById('edit-user-level').value);
            const isBlocked = document.getElementById('edit-user-blocked').checked;

            if (isNaN(balance) || isNaN(level)) {
                return showAlert("Please enter valid numbers for balance and level.");
            }

            try {
                await updateDoc(doc(db, "users", currentEditingUserId), {
                    balance: balance,
                    level: level,
                    isBlocked: isBlocked
                });
                showAlert("User updated successfully!");
                closeEditModal();
            } catch (error) {
                showAlert("Error updating user: " + error.message);
            }
        }

        window.toggleBlockUser = function(userId, isBlocked) {
            const action = isBlocked ? 'unblock' : 'block';
            showConfirm(`Are you sure you want to ${action} this user?`, async () => {
                try {
                    await updateDoc(doc(db, "users", userId), { isBlocked: !isBlocked });
                    showAlert(`User ${action}ed successfully!`);
                } catch (error) { 
                    showAlert("Error: " + error.message); 
                }
            });
        };

        function loadWithdrawals() {
            const withdrawalsTableBody = document.getElementById('withdrawals-table-body');
            const withdrawalsQuery = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            
            const withdrawalsUnsubscribe = onSnapshot(withdrawalsQuery, (snapshot) => {
                allWithdrawals = [];
                withdrawalsTableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    withdrawalsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4 text-gray-500">No withdrawal requests found</td>
                        </tr>
                    `;
                    document.getElementById('withdrawals-count').textContent = 'Showing 0 withdrawals';
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const request = { id: docSnap.id, ...docSnap.data() };
                    allWithdrawals.push(request);
                });
                
                filterWithdrawals('all');
            }, (error) => {
                console.error("Error loading withdrawals:", error);
                withdrawalsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-red-500">Error loading withdrawals: ${error.message}</td>
                    </tr>
                `;
            });
            
            unsubscribeCallbacks.push(withdrawalsUnsubscribe);
        }

        window.filterWithdrawals = function(status) {
            const withdrawalsTableBody = document.getElementById('withdrawals-table-body');
            let filteredWithdrawals = allWithdrawals;
            
            if (status !== 'all') {
                filteredWithdrawals = allWithdrawals.filter(w => w.status === status);
            }
            
            withdrawalsTableBody.innerHTML = '';
            
            if (filteredWithdrawals.length === 0) {
                withdrawalsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-gray-500">No ${status} withdrawal requests found</td>
                    </tr>
                `;
            } else {
                filteredWithdrawals.forEach(request => {
                    const requestedDate = request.requestedAt?.toDate().toLocaleString() || 'N/A';
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="font-mono text-xs">${request.id.substring(0, 8)}...</td>
                            <td>${request.userName || 'N/A'}</td>
                            <td>${request.amount} coins</td>
                            <td>${request.method}</td>
                            <td>${request.paymentDetail || 'N/A'}</td>
                            <td>${requestedDate}</td>
                            <td><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(request.status)}">${request.status}</span></td>
                            <td class="space-x-2">
                                ${request.status === 'pending' ? `
                                    <button class="btn btn-success text-xs" onclick="handleWithdrawal('${request.id}', 'approved')">Approve</button>
                                    <button class="btn btn-danger text-xs" onclick="handleWithdrawal('${request.id}', 'rejected')">Reject</button>
                                ` : 'Completed'}
                            </td>
                        </tr>
                    `;
                    withdrawalsTableBody.innerHTML += row;
                });
            }
            
            document.getElementById('withdrawals-count').textContent = `Showing ${filteredWithdrawals.length} withdrawals`;
            
            // Update button states
            document.querySelectorAll('[onclick^="filterWithdrawals"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');
        };

        window.handleWithdrawal = function(requestId, newStatus) {
            showConfirm(`Are you sure you want to ${newStatus} this withdrawal request?`, async () => {
                const requestRef = doc(db, "withdrawals", requestId);
                try {
                    if (newStatus === 'rejected') {
                        const requestSnap = await getDoc(requestRef);
                        if (requestSnap.exists()) {
                            const requestData = requestSnap.data();
                            const userRef = doc(db, "users", requestData.userId);
                            const userSnap = await getDoc(userRef);
                            if(userSnap.exists()){
                               const currentBalance = userSnap.data().balance || 0;
                               await updateDoc(userRef, { balance: currentBalance + requestData.amount });
                            }
                        }
                    }
                    await updateDoc(requestRef, { status: newStatus });
                    showAlert(`Withdrawal request ${newStatus} successfully!`);
                } catch (error) { 
                    showAlert("Error: " + error.message); 
                }
            });
        };

        function loadTasks() {
            const tasksTableBody = document.getElementById('tasks-table-body');
            const tasksQuery = query(collection(db, "tasks"), orderBy("order", "asc"));
            
            const tasksUnsubscribe = onSnapshot(tasksQuery, (snapshot) => {
                allTasks = [];
                tasksTableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    tasksTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">No tasks found</td>
                        </tr>
                    `;
                    document.getElementById('total-tasks-count').textContent = '0';
                    document.getElementById('active-tasks-count').textContent = '0';
                    return;
                }
                
                let totalTasks = 0;
                let activeTasks = 0;
                let completedToday = 0;
                
                snapshot.forEach(doc => {
                    const task = { id: doc.id, ...doc.data() };
                    allTasks.push(task);
                    totalTasks++;
                    
                    if (task.enabled) {
                        activeTasks++;
                    }
                    
                    // Simple logic for completed today (in real app, you'd track this properly)
                    if (task.current_count > 0) {
                        completedToday += task.current_count;
                    }
                });
                
                document.getElementById('total-tasks-count').textContent = totalTasks;
                document.getElementById('active-tasks-count').textContent = activeTasks;
                document.getElementById('completed-tasks-count').textContent = completedToday;
                
                // Display tasks
                allTasks.forEach(task => {
                    const status = task.current_count >= task.global_limit ? 
                        'Mission Complete' : (task.enabled ? 'Active' : 'Disabled');
                    
                    const statusClass = task.current_count >= task.global_limit ? 
                        'bg-green-100 text-green-800' : (task.enabled ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800');
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td>${task.title}</td>
                            <td>${task.type.replace('_', ' ')}</td>
                            <td>${task.reward} coins</td>
                            <td>${task.current_count || 0}</td>
                            <td>${task.global_limit}</td>
                            <td><span class="px-2 py-1 text-xs rounded-full ${statusClass}">${status}</span></td>
                            <td class="space-x-2">
                                <button class="btn btn-primary text-xs" onclick="editTask('${task.id}')">Edit</button>
                                <button class="btn ${task.enabled ? 'btn-warning' : 'btn-success'} text-xs" onclick="toggleTask('${task.id}', ${task.enabled || false})">${task.enabled ? 'Disable' : 'Enable'}</button>
                                <button class="btn btn-danger text-xs" onclick="deleteTask('${task.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                    tasksTableBody.innerHTML += row;
                });
            }, (error) => {
                console.error("Error loading tasks:", error);
                tasksTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-red-500">Error loading tasks: ${error.message}</td>
                    </tr>
                `;
            });
            
            unsubscribeCallbacks.push(tasksUnsubscribe);
        }

        window.showCreateTaskModal = function() {
            document.getElementById('create-task-modal').classList.remove('hidden');
            // Reset form
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-type').value = 'watch_ads';
            document.getElementById('task-reward').value = '';
            document.getElementById('task-emoji').value = '';
            document.getElementById('task-group-link').value = '';
            document.getElementById('task-video-url').value = '';
            document.getElementById('task-timer-seconds').value = '5';
            document.getElementById('task-video-seconds').value = '30';
            document.getElementById('task-global-limit').value = '1000';
            document.getElementById('task-order').value = '1';
            document.getElementById('task-enabled').checked = true;
            
            handleTaskTypeChange();
        }

        window.closeCreateTaskModal = function() {
            document.getElementById('create-task-modal').classList.add('hidden');
        }

        window.createNewTask = async function() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const type = document.getElementById('task-type').value;
            const reward = parseInt(document.getElementById('task-reward').value);
            const emoji = document.getElementById('task-emoji').value;
            const groupLink = document.getElementById('task-group-link').value;
            const videoUrl = document.getElementById('task-video-url').value;
            const timerSeconds = parseInt(document.getElementById('task-timer-seconds').value);
            const videoSeconds = parseInt(document.getElementById('task-video-seconds').value);
            const globalLimit = parseInt(document.getElementById('task-global-limit').value);
            const order = parseInt(document.getElementById('task-order').value);
            const enabled = document.getElementById('task-enabled').checked;

            if (!title || !reward || !globalLimit || !order) {
                return showAlert("Please fill in all required fields.");
            }

            try {
                const taskData = {
                    title,
                    description,
                    type,
                    reward,
                    emoji: emoji || "✅",
                    global_limit: globalLimit,
                    current_count: 0,
                    order,
                    enabled,
                    created_at: serverTimestamp()
                };

                // Add optional fields based on task type
                if (type === 'group_join' && groupLink) {
                    taskData.group_link = groupLink;
                    taskData.timer_seconds = timerSeconds || 5;
                }

                if (type === 'watch_video' && videoUrl) {
                    taskData.video_url = videoUrl;
                    taskData.video_seconds = videoSeconds || 30;
                }

                await addDoc(collection(db, "tasks"), taskData);
                showAlert("Task created successfully!");
                closeCreateTaskModal();
            } catch (error) {
                showAlert("Error creating task: " + error.message);
            }
        }

        window.editTask = function(taskId) {
            currentEditingTaskId = taskId;
            const task = allTasks.find(t => t.id === taskId);
            
            if (task) {
                document.getElementById('edit-task-id').value = taskId;
                document.getElementById('edit-task-title').value = task.title;
                document.getElementById('edit-task-description').value = task.description || '';
                document.getElementById('edit-task-type').value = task.type;
                document.getElementById('edit-task-reward').value = task.reward;
                document.getElementById('edit-task-emoji').value = task.emoji || '';
                document.getElementById('edit-task-group-link').value = task.group_link || '';
                document.getElementById('edit-task-video-url').value = task.video_url || '';
                document.getElementById('edit-task-timer-seconds').value = task.timer_seconds || 5;
                document.getElementById('edit-task-video-seconds').value = task.video_seconds || 30;
                document.getElementById('edit-task-global-limit').value = task.global_limit;
                document.getElementById('edit-task-current-count').value = task.current_count || 0;
                document.getElementById('edit-task-order').value = task.order;
                document.getElementById('edit-task-enabled').checked = task.enabled;
                
                handleEditTaskTypeChange();
                document.getElementById('edit-task-modal').classList.remove('hidden');
            }
        }

        window.closeEditTaskModal = function() {
            document.getElementById('edit-task-modal').classList.add('hidden');
            currentEditingTaskId = null;
        }

        window.updateTask = async function() {
            if (!currentEditingTaskId) return;

            const title = document.getElementById('edit-task-title').value;
            const description = document.getElementById('edit-task-description').value;
            const reward = parseInt(document.getElementById('edit-task-reward').value);
            const emoji = document.getElementById('edit-task-emoji').value;
            const groupLink = document.getElementById('edit-task-group-link').value;
            const videoUrl = document.getElementById('edit-task-video-url').value;
            const timerSeconds = parseInt(document.getElementById('edit-task-timer-seconds').value);
            const videoSeconds = parseInt(document.getElementById('edit-task-video-seconds').value);
            const globalLimit = parseInt(document.getElementById('edit-task-global-limit').value);
            const order = parseInt(document.getElementById('edit-task-order').value);
            const enabled = document.getElementById('edit-task-enabled').checked;

            if (!title || !reward || !globalLimit || !order) {
                return showAlert("Please fill in all required fields.");
            }

            try {
                const taskData = {
                    title,
                    description,
                    reward,
                    emoji: emoji || "✅",
                    global_limit: globalLimit,
                    order,
                    enabled
                };

                // Add optional fields based on task type
                const type = document.getElementById('edit-task-type').value;
                if (type === 'group_join') {
                    taskData.group_link = groupLink;
                    taskData.timer_seconds = timerSeconds || 5;
                }

                if (type === 'watch_video') {
                    taskData.video_url = videoUrl;
                    taskData.video_seconds = videoSeconds || 30;
                }

                await updateDoc(doc(db, "tasks", currentEditingTaskId), taskData);
                showAlert("Task updated successfully!");
                closeEditTaskModal();
            } catch (error) {
                showAlert("Error updating task: " + error.message);
            }
        }

        window.toggleTask = function(taskId, isEnabled) {
            const action = isEnabled ? 'disable' : 'enable';
            showConfirm(`Are you sure you want to ${action} this task?`, async () => {
                try {
                    await updateDoc(doc(db, "tasks", taskId), { enabled: !isEnabled });
                    showAlert(`Task ${action}d successfully!`);
                } catch (error) { 
                    showAlert("Error: " + error.message); 
                }
            });
        }

        window.deleteTask = function(taskId) {
            showConfirm("Are you sure you want to delete this task? This action cannot be undone.", async () => {
                try {
                    await deleteDoc(doc(db, "tasks", taskId));
                    showAlert("Task deleted successfully!");
                } catch (error) { 
                    showAlert("Error: " + error.message); 
                }
            });
        }

        async function loadTaskConfig() {
            try {
                const configRef = doc(db, "config", "tasks");
                const docSnap = await getDoc(configRef);
                
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    document.getElementById('daily-task-limit').value = config.dailyLimit || 10;
                }
            } catch (error) {
                console.error("Error loading task config:", error);
            }
        }

        async function updateTaskConfig() {
            try {
                const dailyLimit = parseInt(document.getElementById('daily-task-limit').value);
                
                await setDoc(doc(db, "config", "tasks"), {
                    dailyLimit: dailyLimit,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showAlert("Task configuration updated successfully!");
            } catch (error) {
                showAlert("Error updating task config: " + error.message);
            }
        }

        async function loadReferralConfig() {
            try {
                const configRef = doc(db, "config", "referral");
                const docSnap = await getDoc(configRef);
                
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    document.getElementById('referrer-bonus').value = config.referrerBonus || 100;
                    document.getElementById('referee-bonus').value = config.refereeBonus || 100;
                    document.getElementById('referral-enabled').checked = config.enabled !== false;

                    // Load referral stats
                    await loadReferralStats();
                }
            } catch (error) {
                console.error("Error loading referral config:", error);
            }
        }

        async function loadReferralStats() {
            try {
                // Count total referrals
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("referredBy", "!=", null));
                const querySnapshot = await getDocs(q);
                
                document.getElementById('total-referrals-count').textContent = querySnapshot.size;
                
                // Calculate total bonus given
                let totalBonus = 0;
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    // Assuming each referral gives 100 coins bonus (adjust based on your config)
                    totalBonus += 100;
                });
                document.getElementById('total-bonus-given').textContent = `${totalBonus} coins`;
                
                // Count active referrers (users who have referred others)
                const activeReferrers = new Set();
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    activeReferrers.add(user.referredBy);
                });
                document.getElementById('active-referrers').textContent = activeReferrers.size;
                
            } catch (error) {
                console.error("Error loading referral stats:", error);
            }
        }

        async function updateReferralConfig() {
            try {
                const referrerBonus = parseInt(document.getElementById('referrer-bonus').value);
                const refereeBonus = parseInt(document.getElementById('referee-bonus').value);
                const enabled = document.getElementById('referral-enabled').checked;

                await setDoc(doc(db, "config", "referral"), {
                    referrerBonus: referrerBonus,
                    refereeBonus: refereeBonus,
                    enabled: enabled,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showAlert("Referral configuration updated successfully!");
            } catch (error) {
                showAlert("Error updating referral config: " + error.message);
            }
        }

        async function loadLevelConfig() {
            try {
                const configRef = doc(db, "config", "levels");
                const docSnap = await getDoc(configRef);
                
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    const levelsTable = document.getElementById('levels-table-body');
                    levelsTable.innerHTML = '';
                    
                    if (config.levels) {
                        for (const [level, data] of Object.entries(config.levels)) {
                            levelsTable.innerHTML += `
                                <tr>
                                    <td class="font-bold">${level}</td>
                                    <td><input type="number" id="level-${level}-required" value="${data.requiredCoins}" class="w-full px-2 py-1 border rounded"></td>
                                    <td><input type="number" id="level-${level}-bonus" value="${data.bonus}" class="w-full px-2 py-1 border rounded"></td>
                                    <td>
                                        <button class="btn btn-primary text-xs" onclick="updateLevel(${level})">Update</button>
                                        <button class="btn btn-danger text-xs" onclick="deleteLevel(${level})">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading level config:", error);
            }
        }

        window.updateLevel = async function(level) {
            try {
                const requiredCoins = parseInt(document.getElementById(`level-${level}-required`).value);
                const bonus = parseInt(document.getElementById(`level-${level}-bonus`).value);
                
                if (isNaN(requiredCoins) || isNaN(bonus)) {
                    return showAlert("Please enter valid numbers for required coins and bonus.");
                }

                const configRef = doc(db, "config", "levels");
                const docSnap = await getDoc(configRef);
                const currentConfig = docSnap.exists() ? docSnap.data() : { levels: {} };
                
                currentConfig.levels[level] = {
                    requiredCoins: requiredCoins,
                    bonus: bonus
                };
                
                await setDoc(configRef, currentConfig);
                showAlert(`Level ${level} updated successfully!`);
            } catch (error) {
                showAlert("Error updating level: " + error.message);
            }
        }

        window.addNewLevel = async function() {
            try {
                const level = parseInt(document.getElementById('new-level-number').value);
                const requiredCoins = parseInt(document.getElementById('new-level-required').value);
                const bonus = parseInt(document.getElementById('new-level-bonus').value);
                
                if (isNaN(level) || isNaN(requiredCoins) || isNaN(bonus)) {
                    return showAlert("Please enter valid numbers for all fields.");
                }

                const configRef = doc(db, "config", "levels");
                const docSnap = await getDoc(configRef);
                const currentConfig = docSnap.exists() ? docSnap.data() : { levels: {} };
                
                currentConfig.levels[level] = {
                    requiredCoins: requiredCoins,
                    bonus: bonus
                };
                
                await setDoc(configRef, currentConfig);
                showAlert(`Level ${level} added successfully!`);
                
                // Clear form
                document.getElementById('new-level-number').value = '';
                document.getElementById('new-level-required').value = '';
                document.getElementById('new-level-bonus').value = '';
                
                // Reload levels
                loadLevelConfig();
            } catch (error) {
                showAlert("Error adding level: " + error.message);
            }
        }

        window.deleteLevel = async function(level) {
            showConfirm(`Are you sure you want to delete level ${level}?`, async () => {
                try {
                    const configRef = doc(db, "config", "levels");
                    const docSnap = await getDoc(configRef);
                    const currentConfig = docSnap.exists() ? docSnap.data() : { levels: {} };
                    
                    delete currentConfig.levels[level];
                    
                    await setDoc(configRef, currentConfig);
                    showAlert(`Level ${level} deleted successfully!`);
                    loadLevelConfig();
                } catch (error) {
                    showAlert("Error deleting level: " + error.message);
                }
            });
        }

        async function loadSettings() {
            try {
                const configRef = doc(db, "config", "main");
                const docSnap = await getDoc(configRef);
                
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    document.getElementById('min-withdrawal').value = config.minWithdrawal || 5000;
                    document.getElementById('daily-ad-limit').value = config.dailyAdLimit || 10;
                    document.getElementById('coin-value-coins').value = config.coinValueCoins || 1000;
                    document.getElementById('coin-value-inr').value = config.coinValueInr || 10;
                    document.getElementById('payment-methods').value = (config.paymentMethods || []).join(',');
                    document.getElementById('daily-login-bonus').value = config.dailyLoginBonus || 25;
                    document.getElementById('streak-bonus').value = config.streakBonus || 100;
                    document.getElementById('maintenance-mode').checked = config.maintenanceMode || false;
                    document.getElementById('registration-enabled').checked = config.registrationEnabled !== false;
                }

                // Load notification settings
                const notifConfigRef = doc(db, "config", "notifications");
                const notifSnap = await getDoc(notifConfigRef);
                if (notifSnap.exists()) {
                    const notifConfig = notifSnap.data();
                    document.getElementById('notification-sound-enabled').checked = notifConfig.soundEnabled !== false;
                    document.getElementById('notification-bell-animation').checked = notifConfig.bellAnimation !== false;
                }
            } catch (error) {
                console.error("Error loading settings:", error);
            }
        }

        async function saveSettings() {
            try {
                const minWithdrawal = parseInt(document.getElementById('min-withdrawal').value);
                const dailyAdLimit = parseInt(document.getElementById('daily-ad-limit').value);
                const coinValueCoins = parseInt(document.getElementById('coin-value-coins').value);
                const coinValueInr = parseInt(document.getElementById('coin-value-inr').value);
                const paymentMethods = document.getElementById('payment-methods').value.split(',').map(s => s.trim()).filter(Boolean);
                const dailyLoginBonus = parseInt(document.getElementById('daily-login-bonus').value);
                const streakBonus = parseInt(document.getElementById('streak-bonus').value);
                const maintenanceMode = document.getElementById('maintenance-mode').checked;
                const registrationEnabled = document.getElementById('registration-enabled').checked;

                await setDoc(doc(db, "config", "main"), {
                    minWithdrawal: minWithdrawal,
                    dailyAdLimit: dailyAdLimit,
                    coinValueCoins: coinValueCoins,
                    coinValueInr: coinValueInr,
                    paymentMethods: paymentMethods,
                    dailyLoginBonus: dailyLoginBonus,
                    streakBonus: streakBonus,
                    maintenanceMode: maintenanceMode,
                    registrationEnabled: registrationEnabled,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                // Save notification settings
                const soundEnabled = document.getElementById('notification-sound-enabled').checked;
                const bellAnimation = document.getElementById('notification-bell-animation').checked;
                
                await setDoc(doc(db, "config", "notifications"), {
                    soundEnabled: soundEnabled,
                    bellAnimation: bellAnimation,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showAlert("Settings saved successfully!");
            } catch (error) {
                showAlert("Error saving settings: " + error.message);
            }
        }

        async function saveNotificationSettings() {
            try {
                const soundEnabled = document.getElementById('notification-sound-enabled').checked;
                const bellAnimation = document.getElementById('notification-bell-animation').checked;
                
                await setDoc(doc(db, "config", "notifications"), {
                    soundEnabled: soundEnabled,
                    bellAnimation: bellAnimation,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showAlert("Notification settings saved successfully!");
            } catch (error) {
                showAlert("Error saving notification settings: " + error.message);
            }
        }

        async function resetSettings() {
            showConfirm("Are you sure you want to reset all settings to default?", async () => {
                try {
                    const defaultSettings = {
                        minWithdrawal: 5000,
                        dailyAdLimit: 10,
                        coinValueCoins: 1000,
                        coinValueInr: 10,
                        paymentMethods: ["Bkash", "Nagad", "Rocket"],
                        dailyLoginBonus: 25,
                        streakBonus: 100,
                        maintenanceMode: false,
                        registrationEnabled: true,
                        updatedAt: serverTimestamp()
                    };

                    await setDoc(doc(db, "config", "main"), defaultSettings);
                    
                    // Reset notification settings
                    await setDoc(doc(db, "config", "notifications"), {
                        soundEnabled: true,
                        bellAnimation: true,
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    loadSettings();
                    showAlert("Settings reset to default successfully!");
                } catch (error) {
                    showAlert("Error resetting settings: " + error.message);
                }
            });
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            const target = document.getElementById('notification-target').value;

            if (!title || !message) {
                return showAlert("Title and message are required.");
            }

            try {
                await addDoc(collection(db, "notifications"), {
                    title: title,
                    message: message,
                    target: target,
                    createdAt: serverTimestamp(),
                    sentBy: currentAdmin.uid
                });

                showAlert("Notification sent successfully!");
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                loadNotificationHistory();
            } catch (error) {
                showAlert("Error sending notification: " + error.message);
            }
        }

        async function loadNotificationHistory() {
            try {
                const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                const historyContainer = document.getElementById('notification-history');
                historyContainer.innerHTML = '';

                if (querySnapshot.empty) {
                    historyContainer.innerHTML = '<p class="text-gray-500 text-center">No notifications sent yet.</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const notif = doc.data();
                    const date = notif.createdAt ? notif.createdAt.toDate().toLocaleString() : 'N/A';
                    historyContainer.innerHTML += `
                        <div class="p-3 border-b">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold">${notif.title}</h3>
                                    <p class="text-sm text-gray-600">${notif.message}</p>
                                </div>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Target: ${notif.target || 'All users'}</div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("Error loading notification history:", error);
            }
        }

        async function checkAdServiceStatus() {
            try {
                const statusElement = document.getElementById('ad-service-status');
                if (typeof window.show_9549781 === 'function') {
                    statusElement.textContent = 'Active';
                    statusElement.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full';
                } else {
                    statusElement.textContent = 'Inactive';
                    statusElement.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full';
                }
            } catch (error) {
                console.error("Error checking ad service status:", error);
            }
        }

        window.exportUsers = async function() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                let csvContent = "User ID,Name,Email,Balance,Level,Status,Joined Date\n";
                
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    csvContent += `"${doc.id}","${user.name || ''}","${user.email}",${user.balance || 0},${user.level || 1},${user.isBlocked ? 'Blocked' : 'Active'},"${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "users_export.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                showAlert("Error exporting users: " + error.message);
            }
        };

        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }

        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('custom-confirm').classList.remove('hidden');
            
            document.getElementById('confirm-ok-btn').onclick = () => {
                document.getElementById('custom-confirm').classList.add('hidden');
                onConfirm();
            };
        }
    </script>
</body>
</html>
